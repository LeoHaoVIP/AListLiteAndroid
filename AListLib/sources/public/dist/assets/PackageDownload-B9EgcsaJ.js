import{cG as A,B as W,o as j,j as H,k as I,D as S,ae as z,bY as Z,an as D,R as N,ad as O,G,J,K,S as V,l as Y,y as Q,z as L,A as X,_ as ee}from"./index-BeFrtC4h.js";class R{constructor(){this.crc=-1}append(n){for(var a=this.crc|0,f=this.table,h=0,g=n.length|0;h<g;h++)a=a>>>8^f[(a^n[h])&255];this.crc=a}get(){return~this.crc}}R.prototype.table=(()=>{var c,n,a,f=[];for(c=0;c<256;c++){for(a=c,n=0;n<8;n++)a=a&1?a>>>1^3988292384:a>>>1;f[c]=a}return f})();const T=c=>{var n=new Uint8Array(c);return{array:n,view:new DataView(n.buffer)}},te=c=>c.reader.read().then(n=>{if(n.done)return c.writeFooter();const a=n.value;c.crc.append(a),c.uncompressedLength+=a.length,c.compressedLength+=a.length,c.ctrl.enqueue(a)});function re(c){const n=Object.create(null),a=[],f=new TextEncoder;let h=0,g=0,p,l,v;function w(){g++,l=n[a[g]],l?u():v&&C()}var y={enqueue(d){if(v)throw new TypeError("Cannot enqueue a chunk into a readable stream that is closed or has been requested to be closed");let r=d.name.trim();const t=new Date(typeof d.lastModified>"u"?Date.now():d.lastModified);if(d.directory&&!r.endsWith("/")&&(r+="/"),n[r])throw new Error("File already exists.");const s=f.encode(r);a.push(r);const e=n[r]={level:0,ctrl:p,directory:!!d.directory,nameBuf:s,comment:f.encode(d.comment||""),compressedLength:0,uncompressedLength:0,writeHeader(){var o=T(26),i=T(30+s.length);e.offset=h,e.header=o,e.level!==0&&!e.directory&&o.view.setUint16(4,2048),o.view.setUint32(0,335546376),o.view.setUint16(6,(t.getHours()<<6|t.getMinutes())<<5|t.getSeconds()/2,!0),o.view.setUint16(8,(t.getFullYear()-1980<<4|t.getMonth()+1)<<5|t.getDate(),!0),o.view.setUint16(22,s.length,!0),i.view.setUint32(0,1347093252),i.array.set(o.array,4),i.array.set(s,30),h+=i.array.length,p.enqueue(i.array)},writeFooter(){var o=T(16);o.view.setUint32(0,1347094280),e.crc&&(e.header.view.setUint32(10,e.crc.get(),!0),e.header.view.setUint32(14,e.compressedLength,!0),e.header.view.setUint32(18,e.uncompressedLength,!0),o.view.setUint32(4,e.crc.get(),!0),o.view.setUint32(8,e.compressedLength,!0),o.view.setUint32(12,e.uncompressedLength,!0)),p.enqueue(o.array),h+=e.compressedLength+16,w()},fileLike:d};l||(l=e,u())},close(){if(v)throw new TypeError("Cannot close a readable stream that has already been requested to be closed");l||C(),v=!0}};function C(){var d=0,r=0,t,s;for(t=0;t<a.length;t++)s=n[a[t]],d+=46+s.nameBuf.length+s.comment.length;const e=T(d+22);for(t=0;t<a.length;t++)s=n[a[t]],e.view.setUint32(r,1347092738),e.view.setUint16(r+4,5120),e.array.set(s.header.array,r+6),e.view.setUint16(r+32,s.comment.length,!0),s.directory&&e.view.setUint8(r+38,16),e.view.setUint32(r+42,s.offset,!0),e.array.set(s.nameBuf,r+46),e.array.set(s.comment,r+46+s.nameBuf.length),r+=46+s.nameBuf.length+s.comment.length;e.view.setUint32(r,1347093766),e.view.setUint16(r+8,a.length,!0),e.view.setUint16(r+10,a.length,!0),e.view.setUint32(r+12,d,!0),e.view.setUint32(r+16,h,!0),p.enqueue(e.array),p.close()}function u(){if(l){if(l.directory)return l.writeFooter(l.writeHeader());if(l.reader)return te(l);l.fileLike.stream?(l.crc=new R,l.reader=l.fileLike.stream.getReader(),l.writeHeader()):w()}}return new ReadableStream({start:d=>{p=d,c.start&&Promise.resolve(c.start(y))},pull(){return u()||c.pull&&Promise.resolve(c.pull(y))}})}window.ZIP=re;var _={exports:{}};/*! streamsaver. MIT License. Jimmy WÃ¤rting <https://jimmy.warting.se/opensource> */var B;function ae(){return B||(B=1,function(c){((n,a)=>{c.exports=a()})("streamSaver",()=>{const n=typeof window=="object"?window:this;n.HTMLElement||console.warn("streamsaver is meant to run on browsers main thread");let a=null,f=!1;const h=r=>{try{r()}catch(t){}},g=n.WebStreamsPolyfill||{},p=n.isSecureContext;let l=/constructor/i.test(n.HTMLElement)||!!n.safari||!!n.WebKitPoint;const v=p||"MozAppearance"in document.documentElement.style?"iframe":"navigate",w={createWriteStream:d,WritableStream:n.WritableStream||g.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};function y(r){if(!r)throw new Error("meh");const t=document.createElement("iframe");return t.hidden=!0,t.src=r,t.loaded=!1,t.name="iframe",t.isIframe=!0,t.postMessage=(...s)=>t.contentWindow.postMessage(...s),t.addEventListener("load",()=>{t.loaded=!0},{once:!0}),document.body.appendChild(t),t}function C(r){const t="width=200,height=100",s=document.createDocumentFragment(),e={frame:n.open(r,"popup",t),loaded:!1,isIframe:!1,isPopup:!0,remove(){e.frame.close()},addEventListener(...i){s.addEventListener(...i)},dispatchEvent(...i){s.dispatchEvent(...i)},removeEventListener(...i){s.removeEventListener(...i)},postMessage(...i){e.frame.postMessage(...i)}},o=i=>{i.source===e.frame&&(e.loaded=!0,n.removeEventListener("message",o),e.dispatchEvent(new Event("load")))};return n.addEventListener("message",o),e}try{new Response(new ReadableStream),p&&!("serviceWorker"in navigator)&&(l=!0)}catch(r){l=!0}h(()=>{const{readable:r}=new TransformStream,t=new MessageChannel;t.port1.postMessage(r,[r]),t.port1.close(),t.port2.close(),f=!0,Object.defineProperty(w,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})});function u(){a||(a=p?y(w.mitm):C(w.mitm))}function d(r,t,s){let e={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},o=0,i=null,m=null,x=null;if(Number.isFinite(t)?([s,t]=[t,s],console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),e.size=s,e.writableStrategy=t):t&&t.highWaterMark?(console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),e.size=s,e.writableStrategy=t):e=t||{},!l){u(),m=new MessageChannel,r=encodeURIComponent(r.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const b={transferringReadable:f,pathname:e.pathname||Math.random().toString().slice(-6)+"/"+r,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+r}};e.size&&(b.headers["Content-Length"]=e.size);const M=[b,"*",[m.port2]];if(f){const U=v==="iframe"?void 0:{transform(F,$){if(!(F instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");o+=F.length,$.enqueue(F),i&&(location.href=i,i=null)},flush(){i&&(location.href=i)}};x=new w.TransformStream(U,e.writableStrategy,e.readableStrategy);const k=x.readable;m.port1.postMessage({readableStream:k},[k])}m.port1.onmessage=U=>{U.data.download?v==="navigate"?(a.remove(),a=null,o?location.href=U.data.download:i=U.data.download):(a.isPopup&&(a.remove(),a=null,v==="iframe"&&y(w.mitm)),y(U.data.download)):U.data.abort&&(E=[],m.port1.postMessage("abort"),m.port1.onmessage=null,m.port1.close(),m.port2.close(),m=null)},a.loaded?a.postMessage(...M):a.addEventListener("load",()=>{a.postMessage(...M)},{once:!0})}let E=[];return!l&&x&&x.writable||new w.WritableStream({write(b){if(!(b instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");if(l){E.push(b);return}m.port1.postMessage(b),o+=b.length,i&&(location.href=i,i=null)},close(){if(l){const b=new Blob(E,{type:"application/octet-stream; charset=utf-8"}),M=document.createElement("a");M.href=URL.createObjectURL(b),M.download=r,M.click()}else m.port1.postMessage("end")},abort(){E=[],m.port1.postMessage("abort"),m.port1.onmessage=null,m.port1.close(),m.port2.close(),m=null}},e.writableStrategy)}return w})}(_)),_.exports}var ne=ae();const P=A(ne);P.mitm="/streamer/mitm.html";const se=c=>c.replace(/^\/+|\/+$/g,"");let q=0;const ie=c=>{const n=j(),[a,f]=W(n("home.package_download.initializing")),[h,g]=W(0),{pathname:p}=H(),l=I(),v=async(u,d)=>{var r;if(d.is_dir){const t=await X(L(p(),u,d.name),ee());if(t.code!==200)return t.message;const s=[];for(const e of(r=t.data.content)!=null?r:[]){const o=await v(L(u,d.name),e);if(typeof o=="string")return o;s.push(...o)}return s}else return q+=d.size,[{path:L(u,d.name),url:Q(L(p(),u),d,"direct",!0)}]},[w,y]=W([]);return(async()=>{let u=Y(p());l.length===1&&(u=l[0].name),u||(u=n("manage.sidemenu.home"));let d=P.createWriteStream("".concat(u,".zip"),{size:q});f(n("home.package_download.fetching_struct")),g(2);const r=[];for(const e of l){const o=await v("",e);if(typeof o=="string")return f("".concat(n("home.package_download.fetching_struct_failed"),": ").concat(o)),g(1),o;r.push(...o)}f(n("home.package_download.downloading")),g(3);let t=r.values(),s=new window.ZIP({pull(e){const o=t.next();if(o.done)e.close();else{let i=se(o.value.path);l.length===1&&(i=i.replace("".concat(u,"/"),""));const m=o.value.url;return fetch(m).then(x=>{y(E=>[...E,i]),e.enqueue({name:i,stream:x.body})})}}});if(window.WritableStream&&s.pipeTo)return s.pipeTo(d).then(()=>{f("".concat(n("home.package_download.success"))),g(4)}).catch(e=>{f("".concat(n("home.package_download.failed"),": ").concat(e)),g(1)})})(),[S(G,{get children(){return S(z,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[S(Z,{get children(){return[D(()=>n("home.package_download.current_status")),": ",D(()=>a())]}}),S(N,{get each(){return w()},children:u=>S(O,{css:{wordBreak:"break-all"},get children(){return["Fetching: ",u]}})})]}})}}),S(V,{get when(){return[1,4].includes(h())},get children(){return S(J,{get children(){return S(K,{colorScheme:"info",get onClick(){return c.onClose},get children(){return n("global.close")}})}})}})]};export{ie as default};
