import{j as E,B as b,e6 as I,a4 as d,au as P,N as B,ax as H,bq as o,aZ as v,D as f,ac as k,S as _,aa as L,o as A,cp as F,ee as M}from"./index-Bm6_Y9sI.js";var N=H("<div id=heic-container style=justify-content:center;align-items:center><canvas style=max-width:100%;max-height:100%;object-fit:contain>");const W=()=>{const $=A();E();const[u,s]=b(!0),[w,c]=b(!1),{libHeifPath:g}=I();let p=d.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));p.length===0&&(p=[d.obj]);let l,h,r;P(()=>{j()}),B(()=>{l&&h&&(h=null),l=null});const j=async()=>{s(!0),c(!1);try{window.libheif||await C("".concat(g(),"/libheif.js"),"libheif-script");const e=await x("".concat(g(),"/libheif.wasm"));l=window.libheif({wasmBinary:e}),h=new l.HeifDecoder,await S(d.raw_url)}catch(e){console.error("HEIC初始化失败:",e),c(!0),s(!1)}},C=(e,t)=>new Promise((a,i)=>{const n=document.createElement("script");n.src=e,n.id=t,n.onload=()=>a(),n.onerror=()=>i("脚本加载失败: ".concat(e)),document.head.appendChild(n)}),x=async e=>{const t=await fetch(e);if(!t.ok)throw"WASM加载失败: ".concat(e);return await t.arrayBuffer()},S=async e=>{try{s(!0),c(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const a=await t.arrayBuffer(),i=h.decode(a);if(!i||i.length===0)throw"没有可解码的图像";const n=i[0];await D(n),s(!1)}catch(t){console.error("HEIC解码失败:",t),c(!0),s(!1)}},D=e=>new Promise(t=>{if(!r)return t();const a=e.get_width(),i=e.get_height();r.width=a,r.height=i;const n=new ImageData(a,i);e.display(n,m=>{if(!m||!r)return t();const y=r.getContext("2d");if(!y)return t();y.putImageData(m,0,0),t()})});return(()=>{var e=N(),t=e.firstChild;o(e,"position","relative"),o(e,"width","100%"),o(e,"height","75vh"),o(e,"display","flex"),o(e,"overflow","hidden");var a=r;return typeof a=="function"?M(a,t):r=t,v(e,f(_,{get when(){return u()},get children(){return f(k,{})}}),null),v(e,f(_,{get when(){return w()},get children(){return f(L,{get msg(){return $("preview.failed_load_heic")},h:"75vh"})}}),null),F(i=>o(t,"display",u()||w()?"none":"block")),e})()};export{W as default};
