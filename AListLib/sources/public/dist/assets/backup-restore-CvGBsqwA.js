import{B as D,ba as i,br as d,D as o,ax as K,K as J,o as he,bS as be,c0 as ye,bF as A,bR as Se,I as we,ai as N,U as _e,cy as $,r as ke,ah as H}from"./index-mG6bsVSg.js";import{b as Le}from"./useTitle-BrUnaZco.js";import{c as f}from"./index-DsQNokS6.js";const V={success:{icon:"✅",color:"$success9"},error:{icon:"❌",color:"$danger9"},info:{icon:"ℹ️",color:"$info9"}},$e=p=>o(K,{w:"$full",spacing:"$1",get children(){return[o(H,{get children(){return V[p.type].icon}}),o(H,{get color(){return V[p.type].color},get children(){return p.msg}})]}}),je=()=>{const[p,v]=D(!1),[h,S]=D(""),t=he();Le("manage.sidemenu.backup-restore");let w;const[P,W]=D([]),u=(e,r)=>{W(g=>[...g,{type:r,msg:e}]),w.scrollTop=w.scrollHeight},[Y,q]=i(()=>d.get("/admin/setting/list")),[z,j]=i(()=>d.get("/admin/user/list")),[G,O]=i(()=>d.get("/admin/meta/list")),[Q,R]=i(()=>d.get("/admin/storage/list")),[X,x]=i(()=>d.get("/share/list")),Z=()=>Y()||z()||G()||Q()||X();function U(e,r){if(r=="")return e;const g=f.AES.encrypt(JSON.stringify(e),r).toString();return f.enc.Base64.stringify(f.enc.Utf8.parse(g))}function M(e,r,g,c){if(!c)return e;const s=f.enc.Base64.parse(e).toString(f.enc.Utf8);return g?f.AES.decrypt(s,r).toString(f.enc.Utf8):JSON.parse(f.AES.decrypt(s,r).toString(f.enc.Utf8))}const B=async()=>{u(t("br.start_backup"),"info");const e={encrypted:"",settings:[],users:[],storages:[],metas:[],shares:[]};h()!=""&&(e.encrypted=U("encrypted",h()));for(const r of[{name:"settings",fn:q,page:!1},{name:"users",fn:j,page:!0},{name:"storages",fn:R,page:!0},{name:"metas",fn:O,page:!0},{name:"shares",fn:x,page:!0}]){const g=await r.fn();$(g,c=>{if(u(t("br.success_backup_item",{item:t("manage.sidemenu.".concat(r.name))}),"success"),r.page){for(let s=0;s<c.content.length;s++){const n=c.content[s];for(const m in n)n[m]=U(n[m],h())}e[r.name]=c.content}else{for(let s=0;s<c.length;s++){const n=c[s];for(const m in n)n[m]=U(n[m],h())}e[r.name]=c}},c=>{u(t("br.failed_backup_item",{item:t("manage.sidemenu.".concat(r.name))})+":"+c,"error")})}ve("openlist_backup_"+new Date().toLocaleString()+".json",e),u(t("br.finish_backup"),"info")},[ee,te]=i(e=>d.post("/admin/setting/save",e)),[ne,F]=i(e=>d.post("/admin/user/create",e)),[re,T]=i(e=>d.post("/admin/storage/create",e)),[ae,C]=i(e=>d.post("/admin/meta/create",e)),[se,E]=i(e=>d.post("/share/create",e)),[oe,ce]=i(e=>d.post("/admin/user/update",e)),[ie,de]=i(e=>d.post("/admin/storage/update",e)),[ue,ge]=i(e=>d.post("/admin/meta/update",e)),[le,me]=i(e=>d.post("/share/update",e));async function _(e,r,g,c,s,n){const m=(await r()).data.content;for(const y in e){const a=e[y],l=a[s],L=(m.find(I=>I[s]===l)?"update":"add")==="add"?g:c;await $(await L(a),()=>{u(t("br.success_restore_item",{item:t(n)})+"-[".concat(l,"]"),"success")},I=>{u(t("br.failed_restore_item",{item:t(n)})+"-[".concat(l,"]:")+I,"error")})}}const pe=()=>ee()||ne()||re()||ae()||se()||oe()||ie()||ue()||le(),fe=async()=>{u(t("br.start_restore"),"info");const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async r=>{const g=r.target.files;if(!g||g.length===0){ke.warning(t("br.no_file"));return}const c=g[0],s=new FileReader;s.onload=async()=>{const n=JSON.parse(s.result),m=!!n.encrypted;if(m&&M(n.encrypted,h(),!0,!0)!=='"encrypted"'){u(t("br.wrong_encrypt_password"),"error");return}const y=Object.values(n);for(let a=y.length-4;a<y.length;a++){const l=y[a];console.log(l);for(let b=0;b<l.length;b++){const k=l[b];for(const L in k)k[L]=M(k[L],h(),!1,m)}}if(p()&&await B(),n.settings&&$(await te(n.settings.filter(a=>!["version","index_progress"].includes(a.key))),()=>{u(t("br.success_restore_item",{item:t("manage.sidemenu.settings")}),"success")},a=>{u(t("br.failed_restore_item",{item:t("manage.sidemenu.settings")})+":"+a,"error")}),p())await _(n.users,j,F,ce,"username","manage.sidemenu.users"),await _(n.storages,R,T,de,"mount_path","manage.sidemenu.storages"),await _(n.metas,O,C,ge,"path","manage.sidemenu.metas"),await _(n.shares,x,E,me,"id","manage.sidemenu.shares");else for(const a of[{name:"users",fn:F,data:n.users,key:"username",removeId:!0},{name:"storages",fn:T,data:n.storages,key:"mount_path",removeId:!0},{name:"metas",fn:C,data:n.metas,key:"path",removeId:!0},{name:"shares",fn:E,data:n.shares,key:"id",removeId:!1}])for(const l of a.data||[])a.removeId&&(l.id=0),$(await a.fn(l),()=>{u(t("br.success_restore_item",{item:t("manage.sidemenu.".concat(a.name))})+"-[".concat(l[a.key],"]"),"success")},b=>{u(t("br.failed_restore_item",{item:t("manage.sidemenu.".concat(a.name))})+" [ ".concat(l[a.key]," ] :")+b,"error")});u(t("br.finish_restore"),"info")},s.readAsText(c)},e.click()};return o(N,{spacing:"$2",w:"$full",get children(){return[o(K,{spacing:"$2",w:"$full",get children(){return[o(J,{get loading(){return Z()},onClick:()=>{B()},colorScheme:"accent",get children(){return t("br.backup")}}),o(J,{get loading(){return pe()},onClick:()=>{fe()},get children(){return t("br.restore")}})]}}),o(be,{w:"$full",display:"flex",flexDirection:"column",get children(){return o(ye,{w:"$full",direction:"column",gap:"$1",get children(){return[o(A,{get children(){return t("br.override")}}),o(Se,{id:"restore-override",get checked(){return p()},onChange:e=>v(e.currentTarget.checked)}),o(A,{get children(){return t("br.encrypt_password")}}),o(we,{id:"password",type:"password",get placeholder(){return t("br.encrypt_password_placeholder")},onInput:e=>S(e.currentTarget.value)})]}})}}),o(N,{p:"$2",ref(e){var r=w;typeof r=="function"?r(e):w=e},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return o(_e,{get each(){return P()},children:e=>o($e,e)})}})]}})};function ve(p,v){const h=new Blob([JSON.stringify(v,null,2)],{type:"application/json"}),S=URL.createObjectURL(h),t=document.createElement("a");t.href=S,t.download=p,t.click(),URL.revokeObjectURL(S)}export{je as default};
